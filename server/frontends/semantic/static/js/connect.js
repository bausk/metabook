// Generated by CoffeeScript 1.10.0
var Message, Session, imports;

imports = {
  data: require("./data")
};

Session = (function() {
  function Session(url) {
    this.id = joint.util.uuid();
    this.ws = new WebSocket("ws://" + url + this.id);
    this.ws.onopen = this.onopen;
    this.ws.onmessage = this.onmessage;
    this.ws.onclose = this.onclose;
  }

  Session.prototype.onopen = function(evt) {
    return console.log('<connection onopen>');
  };

  Session.prototype.connect_notebook = function(local_path) {
    var msg;
    msg = this.new_message({
      type: 'connect notebook'
    });
    return this.ws.send(msg.serialize());
  };

  Session.prototype.new_message = function(arg) {
    var content, type;
    type = arg.type, content = arg.content;
    return new Message({
      session: this.id,
      msg_type: type,
      content: content
    });
  };

  Session.prototype.run_cell = function(node_model, event) {
    var cells, ids, links, msg;
    cells = importsimports.data.get_cells(node_model.graph.metabook);
    links = importsimports.data.get_links(node_model.graph.metabook);
    ids = [node_model.id];
    msg = new Message({
      session: this.id,
      msg_type: "update",
      content: {
        cells: cells,
        links: links,
        ids: ids
      }
    });
    return this.ws.send(msg.serialize());
  };

  Session.prototype.solve_all = function(metabook_model, event) {
    var cells, ids, links, msg;
    cells = imports.data.get_cells(metabook_model);
    links = imports.data.get_links(metabook_model);
    ids = imports.data.get_ids(cells);
    msg = new Message({
      session: this.id,
      msg_type: "solve",
      content: {
        cells: cells,
        links: links,
        ids: ids
      }
    });
    this.ws.send(msg.serialize());
    return console.log("solve_all: " + this.id);
  };

  Session.prototype.onmessage = function(evt) {
    return console.log(JSON.parse(evt.data));
  };

  Session.prototype.onclose = function(evt) {
    console.log("<session:closed>");
    return Backbone.trigger('session:closed', this);
  };

  Session.prototype.custom_events = {
    'run': Session.prototype.run_cell
  };

  return Session;

})();

Message = (function() {
  function Message(arg) {
    var msg_type, session;
    session = arg.session, msg_type = arg.msg_type, this.header = arg.header, this.parent_header = arg.parent_header, this.metadata = arg.metadata, this.content = arg.content;
    if (this.header == null) {
      this.header = this.defaults.header();
    }
    this.header.session = session;
    this.header.msg_type = msg_type;
    if (this.metadata == null) {
      this.metadata = this.defaults.metadata;
    }
    if (this.parent_header == null) {
      this.parent_header = this.defaults.parent_header;
    }
    if (this.content == null) {
      this.content = this.defaults.content;
    }
  }

  Message.prototype.defaults = {
    header: function() {
      return {
        msg_id: joint.util.uuid(),
        username: "default",
        session: "",
        date: "",
        msg_type: "default",
        version: '1'
      };
    },
    metadata: {},
    parent_header: {},
    content: {}
  };

  Message.prototype.serialize = function() {
    return JSON.stringify(this);
  };

  return Message;

})();

module.exports = {
  Session: Session,
  Message: Message
};

//# sourceMappingURL=connect.js.map
